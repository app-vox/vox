name: Transcription Pipeline Tests

on:
  push:
    branches:
      - main
    paths:
      - "src/shared/constants.ts"
      - "tests/pipeline/**"
  pull_request:
    paths:
      - "src/shared/constants.ts"
      - "tests/pipeline/**"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  pipeline-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Cache Whisper model
        id: cache-whisper
        uses: actions/cache@v5
        with:
          path: whisper-models
          key: whisper-model-small
      - name: Download Whisper model
        if: steps.cache-whisper.outputs.cache-hit != 'true'
        run: |
          mkdir -p whisper-models
          curl -L -o whisper-models/ggml-small.bin \
            https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-small.bin
      - name: Write pipeline test config
        run: |
          cat > pipeline-test-config.json << HEREDOC
          {
            "llm": {
              "provider": "${{ vars.PIPELINE_TEST_LLM_PROVIDER }}",
              "apiKey": "${{ secrets.PIPELINE_TEST_LLM_API_KEY }}",
              "model": "${{ vars.PIPELINE_TEST_LLM_MODEL }}",
              "baseUrl": "${{ vars.PIPELINE_TEST_LLM_BASE_URL }}"
            },
            "whisper": {
              "modelPath": "${{ github.workspace }}/whisper-models/ggml-small.bin"
            }
          }
          HEREDOC
      - name: Run pipeline tests
        run: npm run test:pipeline
        env:
          VOX_PIPELINE_TEST_CONFIG: ./pipeline-test-config.json
      - name: Upload HTML report
        id: upload-report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: pipeline-test-report
          path: tests/pipeline/.results/report.html
          if-no-files-found: ignore
      - name: Write job summary
        if: always()
        run: |
          [ -f tests/pipeline/.results/report.md ] && cat tests/pipeline/.results/report.md >> "$GITHUB_STEP_SUMMARY" || true
      - name: Comment report on PR
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          [ ! -f tests/pipeline/.results/report.md ] && exit 0
          PR=$(gh pr list --head "${{ github.ref_name }}" --json number -q '.[0].number')
          [ -z "$PR" ] && exit 0
          MARKER="<!-- pipeline-test-report -->"
          ARTIFACT_ID="${{ steps.upload-report.outputs.artifact-id }}"
          ARTIFACT_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${ARTIFACT_ID}"
          REPORT="$(cat tests/pipeline/.results/report.md)"
          if [ -n "$ARTIFACT_ID" ]; then
            BODY="${MARKER}"$'\n'"${REPORT}"$'\n\n'"ðŸ“„ [Download full HTML report](${ARTIFACT_URL})"
          else
            BODY="${MARKER}"$'\n'"${REPORT}"
          fi
          COMMENT_ID=$(gh api "repos/${{ github.repository }}/issues/${PR}/comments" \
            --paginate --jq ".[] | select(.body | startswith(\"${MARKER}\")) | .id" | tail -1)
          if [ -n "$COMMENT_ID" ]; then
            gh api "repos/${{ github.repository }}/issues/comments/${COMMENT_ID}" -X PATCH -f body="$BODY"
          else
            gh pr comment "$PR" --body "$BODY"
          fi

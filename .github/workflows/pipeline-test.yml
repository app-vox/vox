name: Pipeline Tests

on:
  push:
    paths:
      - "src/shared/constants.ts"
      - "tests/pipeline/**"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  pipeline-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Cache Whisper model
        id: cache-whisper
        uses: actions/cache@v4
        with:
          path: whisper-models
          key: whisper-model-small
      - name: Download Whisper model
        if: steps.cache-whisper.outputs.cache-hit != 'true'
        run: |
          mkdir -p whisper-models
          curl -L -o whisper-models/ggml-small.bin \
            https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-small.bin
      - name: Write pipeline test config
        run: |
          cat > pipeline-test-config.json << HEREDOC
          {
            "llm": {
              "provider": "${{ vars.PIPELINE_TEST_LLM_PROVIDER }}",
              "apiKey": "${{ secrets.PIPELINE_TEST_LLM_API_KEY }}",
              "model": "${{ vars.PIPELINE_TEST_LLM_MODEL }}",
              "baseUrl": "${{ vars.PIPELINE_TEST_LLM_BASE_URL }}"
            },
            "whisper": {
              "modelPath": "${{ github.workspace }}/whisper-models/ggml-small.bin"
            }
          }
          HEREDOC
      - name: Run pipeline tests
        run: npm run test:pipeline
        env:
          VOX_PIPELINE_TEST_CONFIG: ./pipeline-test-config.json
